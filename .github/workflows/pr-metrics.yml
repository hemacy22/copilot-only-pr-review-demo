
name: PR Metrics
on:
  pull_request:
    types: [opened, reopened, ready_for_review, closed]
  pull_request_review:
    types: [submitted]

jobs:
  collect:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/github-script@v7
        id: metrics
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path='metrics/pr-metrics.json';
            let db=[]; try{ db=JSON.parse(fs.readFileSync(path,'utf8')); }catch{}
            const repo=context.repo;
            const pr = context.payload.pull_request || (await github.rest.pulls.get({ ...repo, pull_number: context.payload.number })).data;
            let row = db.find(x=>x.number===pr.number);
            if(!row){
              row={ number: pr.number, author: pr.user.login, created_at: pr.created_at,
                    merged_at: null, first_review_at: null, first_human_review_at: null, first_copilot_review_at: null };
              db.push(row);
            }
            if(context.eventName==='pull_request_review' && context.payload.action==='submitted'){
              const review=context.payload.review;
              const isBot=review.user && review.user.type==='Bot';
              const isCopilot=isBot && /copilot/i.test(review.user.login||'');
              row.first_review_at ||= review.submitted_at;
              if(isCopilot) row.first_copilot_review_at ||= review.submitted_at;
              if(!isBot) row.first_human_review_at ||= review.submitted_at;
            }
            if(context.eventName==='pull_request' && context.payload.action==='closed' && pr.merged_at){
              row.merged_at = pr.merged_at;
            }
            fs.mkdirSync('metrics', { recursive: true });
            fs.writeFileSync(path, JSON.stringify(db,null,2));
      - name: Commit metrics
        if: ${{ always() }}
        run: |
          git config user.name "metrics-bot"
          git config user.email "metrics-bot@users.noreply.github.com"
          git add metrics/pr-metrics.json
          git commit -m "Update PR metrics [skip ci]" || echo "No changes"
          git push
